package com.example.driver.Config;

import feign.Client;
import org.apache.http.conn.ssl.NoopHostnameVerifier;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.ssl.SSLContextBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSocketFactory;

import java.io.File;

@Configuration
public class FeignSslConfig {

	@Bean
	public Client feignClient() throws Exception {
	    SSLContext sslContext = SSLContextBuilder.create()
	            .loadKeyMaterial(new File("src/main/resources/certificates/driver-service.jks"), "changeit".toCharArray(), "changeit".toCharArray())
	            .loadTrustMaterial(new File("src/main/resources/certificates/driver-service-truststore.jks"), "changeit".toCharArray())
	            .build();

	    SSLConnectionSocketFactory csf = new SSLConnectionSocketFactory(sslContext, NoopHostnameVerifier.INSTANCE);

	    CloseableHttpClient httpClient = HttpClients.custom()
	            .setSSLSocketFactory(csf)
	            .build();

	    return new feign.httpclient.ApacheHttp Client(httpClient);
	}

}
