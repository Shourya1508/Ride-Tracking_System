package com.example.ride.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.ride.Entity.Ride;
import com.example.ride.RabbitmqPublisher.NotificationPublisher;
import com.example.ride.Repository.RideRepository;
import com.example.ride.Service.DriverTrackingService;
import com.example.ride.Service.UserServiceClient;

@RestController
@RequestMapping("/rides")
public class DriverLocationController {

    @Autowired
    private DriverTrackingService  trackingService;
    @Autowired
    private RideRepository rideRepository;
    
    @Autowired
    private NotificationPublisher notificationPublisher;
    
    @Autowired
    private UserServiceClient userServiceClient;
    
    @PostMapping
    public Ride createRide(@RequestBody Ride ride) {
        ride.setStatus("REQUESTED"); // default status
        Ride savedRide = rideRepository.save(ride);
        
        UserServiceClient.UserResponse user = userServiceClient.getUserById(ride.getUserId());
        String email = user.getEmail();
        
        notificationPublisher.sendRideNotification(email, "Your ride has been requested!");
        return savedRide;
    }
    



    @PostMapping("/driver/{driverId}/location")
    public void updateLocation(
            @PathVariable Long driverId,
            @RequestParam Double lat,
            @RequestParam Double lon) {

        trackingService.updateLocation(driverId, lat, lon);
    }
}

